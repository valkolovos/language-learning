# AI Language Learning Frontend - Just Commands
# Run with: just <command> or just --list to see all commands

# Helper function to run npm commands with proper Node.js version
# This works in both local (with nvm) and CI (without nvm) environments
run-npm command:
    @if command -v nvm &> /dev/null; then \
        nvm use && npm {{command}}; \
    else \
        npm {{command}}; \
    fi

# Default command - show help
default:
    @just --list

# Source nvm and use correct Node.js version
nvm-use:
    @echo "Using Node.js version from .nvmrc..."
    @if command -v nvm &> /dev/null; then \
        source ~/.nvm/nvm.sh && nvm use; \
        echo "Current Node.js version:"; \
        source ~/.nvm/nvm.sh && node --version; \
    else \
        echo "nvm not available, using system Node.js:"; \
        node --version; \
    fi

# Install dependencies
install:
    @echo "Installing dependencies..."
    @npm install

# Install production dependencies only
install-prod:
    @echo "Installing production dependencies..."
    @npm ci --only=production

# Show Node.js version info
node-info:
    @echo "Node.js version information:"
    @echo "Current version:"
    @node --version
    @echo "npm version:"
    @npm --version
    @if command -v nvm &> /dev/null; then \
        echo "nvm current:"; \
        source ~/.nvm/nvm.sh && nvm current; \
        echo "Available versions:"; \
        source ~/.nvm/nvm.sh && nvm list; \
    else \
        echo "nvm: not available"; \
    fi

# Start development server
dev:
    @echo "Starting development server..."
    @npm start

# Build for production
build:
    @echo "Building for production..."
    @npm run build

# Build and analyze bundle
build-analyze:
    @echo "Building and analyzing bundle..."
    @if command -v nvm &> /dev/null; then \
        nvm use && npm run build; \
    else \
        npm run build; \
    fi
    @if command -v nvm &> /dev/null; then \
        nvm use && npx webpack-bundle-analyzer build/static/js/*.js; \
    else \
        npx webpack-bundle-analyzer build/static/js/*.js; \
    fi

# Run tests
test:
    @echo "Running tests..."
    @npm test -- --watchAll=false

# Run tests in watch mode
test-watch:
    @echo "Running tests in watch mode..."
    @if command -v nvm &> /dev/null; then \
        nvm use && npm test -- --watch; \
    else \
        npm test -- --watch; \
    fi

# Run tests with coverage
test-cov:
    @echo "Running tests with coverage..."
    @npm run test:coverage

# Run E2E tests
test-e2e:
    @echo "Running E2E tests..."
    @if command -v nvm &> /dev/null; then \
        nvm use && npm run test:e2e; \
    else \
        npm run test:e2e; \
    fi

# Run E2E tests in headed mode
test-e2e-headed:
    @echo "Running E2E tests in headed mode..."
    @if command -v nvm &> /dev/null; then \
        nvm use && npm run test:e2e -- --headed; \
    else \
        npm run test:e2e -- --headed; \
    fi

# Run E2E tests with specific browser
test-e2e-browser browser:
    @echo "Running E2E tests with {{browser}}..."
    @source ~/.nvm/nvm.sh && nvm use && npm run test:e2e -- --project={{browser}}

# Lint code
lint:
    @echo "Running ESLint..."
    @npm run lint

# Auto-fix linting issues
lint-fix:
    @echo "Auto-fixing linting issues..."
    @just run-npm "run lint:fix"
    @echo "Frontend linting issues auto-fixed! âœ¨"

# Format code
format:
    @echo "Formatting code with Prettier..."
    @just run-npm "run format"

# Check code formatting
format-check:
    @echo "Checking code formatting..."
    @npm run format -- --check

# Type checking
type-check:
    @echo "Running TypeScript type checking..."
    @npm run type-check

# Run all code quality checks
quality: lint format-check type-check
    @echo "All code quality checks passed! âœ¨"

# Start storybook
storybook:
    @echo "Starting Storybook..."
    @just run-npm "run storybook"

# Build storybook
storybook-build:
    @echo "Building Storybook..."
    @just run-npm "run build-storybook"

# Start development server with HTTPS
dev-https:
    @echo "Starting development server with HTTPS..."
    @if command -v nvm &> /dev/null; then \
        nvm use && HTTPS=true npm start; \
    else \
        HTTPS=true npm start; \
    fi

# Start development server on specific port
dev-port port:
    @echo "Starting development server on port {{port}}..."
    @if command -v nvm &> /dev/null; then \
        nvm use && PORT={{port}} npm start; \
    else \
        PORT={{port}} npm start; \
    fi

# Bundle analysis
analyze:
    @echo "Analyzing bundle..."
    @just run-npm "run build"
    @if command -v nvm &> /dev/null; then \
        nvm use && npx webpack-bundle-analyzer build/static/js/*.js; \
    else \
        npx webpack-bundle-analyzer build/static/js/*.js; \
    fi

# Performance audit
audit:
    @echo "Running performance audit..."
    @just run-npm "run build"
    @if command -v nvm &> /dev/null; then \
        nvm use && npx lighthouse http://localhost:3000 --output=html --output-path=./lighthouse-report.html; \
    else \
        npx lighthouse http://localhost:3000 --output=html --output-path=./lighthouse-report.html; \
    fi

# Check for security vulnerabilities
security:
    @echo "Checking for security vulnerabilities..."
    @just run-npm "audit"
    @just run-npm "audit --audit-level=moderate"

# Fix security vulnerabilities
security-fix:
    @echo "Fixing security vulnerabilities..."
    @just run-npm "audit fix"

# Update dependencies
update:
    @echo "Updating dependencies..."
    @just run-npm "update"
    @just run-npm "audit fix"

# Clean build artifacts
clean:
    @echo "Cleaning build artifacts..."
    rm -rf build/
    rm -rf node_modules/.cache/
    rm -rf coverage/
    rm -rf .nyc_output/

# Clean all (including node_modules)
clean-all: clean
    @echo "Removing node_modules..."
    rm -rf node_modules/
    rm -f package-lock.json

# Docker commands
docker-build:
    @echo "Building Docker image..."
    docker build -t ai-language-learning-frontend .

docker-run:
    @echo "Running Docker container..."
    docker run -p 3000:3000 ai-language-learning-frontend

# Development workflow
workflow: quality test-cov
    @echo "Development workflow completed! ðŸŽ‰"

# Pre-commit checks
pre-commit: quality test
    @echo "Pre-commit checks passed! âœ¨"

# CI pipeline simulation
ci: quality test-cov test-e2e security
    @echo "CI pipeline completed! ðŸš€"

# Start all development tools
dev-tools: dev storybook
    @echo "All development tools started!"

# Health check
health:
    @echo "Checking application health..."
    curl -f http://localhost:3000 || echo "Application not running"

# Show bundle size
bundle-size:
    @echo "Analyzing bundle size..."
    @source ~/.nvm/nvm.sh && nvm use && npm run build
    @source ~/.nvm/nvm.sh && npx webpack-bundle-analyzer build/static/js/*.js --mode=static

# Run specific test file
test-file file:
    @echo "Running tests in {{file}}..."
    @source ~/.nvm/nvm.sh && nvm use && npm test -- {{file}}

# Run specific test with pattern
test-pattern pattern:
    @echo "Running tests matching pattern: {{pattern}}..."
    @source ~/.nvm/nvm.sh && nvm use && npm test -- --testNamePattern="{{pattern}}"

# Run tests with specific environment
test-env env:
    @echo "Running tests with environment: {{env}}..."
    @source ~/.nvm/nvm.sh && nvm use && NODE_ENV={{env}} npm test

# Development server with specific host
dev-host host:
    @echo "Starting development server on host {{host}}..."
    @source ~/.nvm/nvm.sh && nvm use && HOST={{host}} npm start

# Help
help:
    @echo "AI Language Learning Frontend - Available Commands:"
    @echo ""
    @echo "Node.js Management:"
    @echo "  just nvm-use         - Use Node.js version from .nvmrc"
    @echo "  just node-info       - Show Node.js version information"
    @echo ""
    @echo "Development:"
    @echo "  just dev             - Start development server"
    @echo "  just build           - Build for production"
    @echo "  just install         - Install dependencies"
    @echo ""
    @echo "Testing:"
    @echo "  just test            - Run tests"
    @echo "  just test-cov        - Run tests with coverage"
    @echo "  just test-e2e        - Run E2E tests"
    @echo ""
    @echo "Code Quality:"
    @echo "  just lint            - Run ESLint"
    @echo "  just format          - Format code"
    @echo "  just quality         - Run all quality checks"
    @echo ""
    @echo "Utilities:"
    @echo "  just clean           - Clean build artifacts"
    @echo "  just analyze         - Analyze bundle"
    @echo "  just help            - Show this help"

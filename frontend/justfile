# AI Language Learning Frontend - Just Commands
# Run with: just <command> or just --list to see all commands

# Default command - show help
default:
    @just --list

# Source nvm and use correct Node.js version
nvm-use:
    @echo "Using Node.js version from .nvmrc..."
    @if command -v nvm &> /dev/null; then \
        source ~/.nvm/nvm.sh && nvm use; \
        echo "Current Node.js version:"; \
        source ~/.nvm/nvm.sh && node --version; \
    else \
        echo "nvm not available, using system Node.js:"; \
        node --version; \
    fi

# Install dependencies
install:
    @echo "Installing dependencies..."
    @if command -v nvm &> /dev/null; then \
        source ~/.nvm/nvm.sh && nvm use && npm install; \
    else \
        npm install; \
    fi

# Install production dependencies only
install-prod:
    @echo "Installing production dependencies..."
    @if command -v nvm &> /dev/null; then \
        source ~/.nvm/nvm.sh && nvm use && npm ci --only=production; \
    else \
        npm ci --only=production; \
    fi

# Show Node.js version info
node-info:
    @echo "Node.js version information:"
    @echo "Current version:"
    @if command -v nvm &> /dev/null; then \
        source ~/.nvm/nvm.sh && node --version; \
        echo "npm version:"; \
        source ~/.nvm/nvm.sh && npm --version; \
        echo "nvm current:"; \
        source ~/.nvm/nvm.sh && nvm current; \
        echo "Available versions:"; \
        source ~/.nvm/nvm.sh && nvm list; \
    else \
        node --version; \
        echo "npm version:"; \
        npm --version; \
        echo "nvm: not available"; \
    fi

# Start development server
dev:
    @echo "Starting development server..."
    @if command -v nvm &> /dev/null; then \
        source ~/.nvm/nvm.sh && nvm use && npm start; \
    else \
        npm start; \
    fi

# Build for production
build:
    @echo "Building for production..."
    @if command -v nvm &> /dev/null; then \
        source ~/.nvm/nvm.sh && nvm use && npm run build; \
    else \
        npm run build; \
    fi

# Build and analyze bundle
build-analyze:
    @echo "Building and analyzing bundle..."
    @source ~/.nvm/nvm.sh && nvm use && npm run build
    @source ~/.nvm/nvm.sh && npx webpack-bundle-analyzer build/static/js/*.js

# Run tests
test:
    @echo "Running tests..."
    @if command -v nvm &> /dev/null; then \
        source ~/.nvm/nvm.sh && nvm use && npm test -- --watchAll=false; \
    else \
        npm test -- --watchAll=false; \
    fi

# Run tests in watch mode
test-watch:
    @echo "Running tests in watch mode..."
    @source ~/.nvm/nvm.sh && nvm use && npm test -- --watch

# Run tests with coverage
test-cov:
    @echo "Running tests with coverage..."
    @if command -v nvm &> /dev/null; then \
        source ~/.nvm/nvm.sh && nvm use && npm run test:coverage; \
    else \
        npm run test:coverage; \
    fi

# Run E2E tests
test-e2e:
    @echo "Running E2E tests..."
    @source ~/.nvm/nvm.sh && nvm use && npm run test:e2e

# Run E2E tests in headed mode
test-e2e-headed:
    @echo "Running E2E tests in headed mode..."
    @source ~/.nvm/nvm.sh && nvm use && npm run test:e2e -- --headed

# Run E2E tests with specific browser
test-e2e-browser browser:
    @echo "Running E2E tests with {{browser}}..."
    @source ~/.nvm/nvm.sh && nvm use && npm run test:e2e -- --project={{browser}}

# Lint code
lint:
    @echo "Running ESLint..."
    @if command -v nvm &> /dev/null; then \
        source ~/.nvm/nvm.sh && nvm use && npm run lint; \
    else \
        npm run lint; \
    fi

# Auto-fix linting issues
lint-fix:
    @echo "Auto-fixing linting issues..."
    @source ~/.nvm/nvm.sh && nvm use && npm run lint:fix
    @echo "Frontend linting issues auto-fixed! âœ¨"

# Format code
format:
    @echo "Formatting code with Prettier..."
    @source ~/.nvm/nvm.sh && nvm use && npm run format

# Check code formatting
format-check:
    @echo "Checking code formatting..."
    @if command -v nvm &> /dev/null; then \
        source ~/.nvm/nvm.sh && nvm use && npm run format -- --check; \
    else \
        npm run format -- --check; \
    fi

# Type checking
type-check:
    @echo "Running TypeScript type checking..."
    @if command -v nvm &> /dev/null; then \
        source ~/.nvm/nvm.sh && nvm use && npm run type-check; \
    else \
        npm run type-check; \
    fi

# Run all code quality checks
quality: lint format-check type-check
    @echo "All code quality checks passed! âœ¨"

# Start storybook
storybook:
    @echo "Starting Storybook..."
    @source ~/.nvm/nvm.sh && nvm use && npm run storybook

# Build storybook
storybook-build:
    @echo "Building Storybook..."
    @source ~/.nvm/nvm.sh && nvm use && npm run build-storybook

# Start development server with HTTPS
dev-https:
    @echo "Starting development server with HTTPS..."
    @source ~/.nvm/nvm.sh && nvm use && HTTPS=true npm start

# Start development server on specific port
dev-port port:
    @echo "Starting development server on port {{port}}..."
    @source ~/.nvm/nvm.sh && nvm use && PORT={{port}} npm start

# Bundle analysis
analyze:
    @echo "Analyzing bundle..."
    @source ~/.nvm/nvm.sh && nvm use && npm run build
    @source ~/.nvm/nvm.sh && npx webpack-bundle-analyzer build/static/js/*.js

# Performance audit
audit:
    @echo "Running performance audit..."
    @source ~/.nvm/nvm.sh && nvm use && npm run build
    @source ~/.nvm/nvm.sh && npx lighthouse http://localhost:3000 --output=html --output-path=./lighthouse-report.html

# Check for security vulnerabilities
security:
    @echo "Checking for security vulnerabilities..."
    @source ~/.nvm/nvm.sh && nvm use && npm audit
    @source ~/.nvm/nvm.sh && npm audit --audit-level=moderate

# Fix security vulnerabilities
security-fix:
    @echo "Fixing security vulnerabilities..."
    @source ~/.nvm/nvm.sh && nvm use && npm audit fix

# Update dependencies
update:
    @echo "Updating dependencies..."
    @source ~/.nvm/nvm.sh && nvm use && npm update
    @source ~/.nvm/nvm.sh && npm audit fix

# Clean build artifacts
clean:
    @echo "Cleaning build artifacts..."
    rm -rf build/
    rm -rf node_modules/.cache/
    rm -rf coverage/
    rm -rf .nyc_output/

# Clean all (including node_modules)
clean-all: clean
    @echo "Removing node_modules..."
    rm -rf node_modules/
    rm -f package-lock.json

# Docker commands
docker-build:
    @echo "Building Docker image..."
    docker build -t ai-language-learning-frontend .

docker-run:
    @echo "Running Docker container..."
    docker run -p 3000:3000 ai-language-learning-frontend

# Development workflow
workflow: quality test-cov
    @echo "Development workflow completed! ðŸŽ‰"

# Pre-commit checks
pre-commit: quality test
    @echo "Pre-commit checks passed! âœ¨"

# CI pipeline simulation
ci: quality test-cov test-e2e security
    @echo "CI pipeline completed! ðŸš€"

# Start all development tools
dev-tools: dev storybook
    @echo "All development tools started!"

# Health check
health:
    @echo "Checking application health..."
    curl -f http://localhost:3000 || echo "Application not running"

# Show bundle size
bundle-size:
    @echo "Analyzing bundle size..."
    @source ~/.nvm/nvm.sh && nvm use && npm run build
    @source ~/.nvm/nvm.sh && npx webpack-bundle-analyzer build/static/js/*.js --mode=static

# Run specific test file
test-file file:
    @echo "Running tests in {{file}}..."
    @source ~/.nvm/nvm.sh && nvm use && npm test -- {{file}}

# Run specific test with pattern
test-pattern pattern:
    @echo "Running tests matching pattern: {{pattern}}..."
    @source ~/.nvm/nvm.sh && nvm use && npm test -- --testNamePattern="{{pattern}}"

# Run tests with specific environment
test-env env:
    @echo "Running tests with environment: {{env}}..."
    @source ~/.nvm/nvm.sh && nvm use && NODE_ENV={{env}} npm test

# Development server with specific host
dev-host host:
    @echo "Starting development server on host {{host}}..."
    @source ~/.nvm/nvm.sh && nvm use && HOST={{host}} npm start

# Help
help:
    @echo "AI Language Learning Frontend - Available Commands:"
    @echo ""
    @echo "Node.js Management:"
    @echo "  just nvm-use         - Use Node.js version from .nvmrc"
    @echo "  just node-info       - Show Node.js version information"
    @echo ""
    @echo "Development:"
    @echo "  just dev             - Start development server"
    @echo "  just build           - Build for production"
    @echo "  just install         - Install dependencies"
    @echo ""
    @echo "Testing:"
    @echo "  just test            - Run tests"
    @echo "  just test-cov        - Run tests with coverage"
    @echo "  just test-e2e        - Run E2E tests"
    @echo ""
    @echo "Code Quality:"
    @echo "  just lint            - Run ESLint"
    @echo "  just format          - Format code"
    @echo "  just quality         - Run all quality checks"
    @echo ""
    @echo "Utilities:"
    @echo "  just clean           - Clean build artifacts"
    @echo "  just analyze         - Analyze bundle"
    @echo "  just help            - Show this help"
